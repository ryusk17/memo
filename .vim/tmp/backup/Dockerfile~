FROM php:7.4-apache

RUN apt-get update && \
    apt-get install -y apt-utils vim zip unzip zlib1g git libzip-dev && \
    docker-php-ext-install mysqli pdo_mysql zip && \
    a2enmod rewrite

RUN pecl install xdebug \
  && docker-php-ext-enable xdebug

COPY --from=composer /usr/bin/composer /usr/bin/composer

# environment
ARG BUILD_ENV

# copy all sources
COPY . /var/www/www

# workdir change
WORKDIR /var/www/www

# run composer install
ENV COMPOSER_ALLOW_SUPERUSER=1 \
    COMPOSER_NO_INTERACTION=1

RUN echo pwd: `pwd` && echo ls: `ls -l`

RUN if [ "${BUILD_ENV}" = "production" ]; \
    then \
        composer install --no-dev --no-scripts --optimize-autoloader; \
    else \
        composer install; \
    fi

# share volume
VOLUME /var/www/www



# COPY --from=composer /usr/bin/composer /usr/bin/composer
# 
# COPY . /var/www/html/
# 
# WORKDIR /var/www/html/
# # 
# # # COPY composer.json composer.lock ./
# # # RUN composer install --no-scripts --no-autoloader
# RUN echo pwd: `pwd` && echo ls: `ls`
# # 
# RUN composer install
# 
# # COPY . .
# # RUN chmod +x artisan
# 
# RUN composer dump-autoload --optimize && composer run-script post-install-cmd
# 
# # CMD php artisan serve --host 0.0.0.0 --port 5001
# 
# 
# # RUN cd /var/www/html/app/ && \
# #     composer install
